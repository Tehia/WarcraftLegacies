
// 
// Frostwolf
// 
//   Warcraft III AI script
//   Generated by the Warcraft III World Editor
// 


//***************************************************************************
//*
//*  Global Variables
//*
//***************************************************************************

globals
    integer                 attackWave                 = 1
    integer                 nextDelay                  = 0
    integer                 awGold                     = 0
    integer                 awWood                     = 0
endglobals

//***************************************************************************
//*
//*  Utility Functions
//*
//***************************************************************************

function CheckLastCommand takes boolean pop returns integer
    local integer cmd = GetLastCommand()
    if (pop) then
        call PopLastCommand()
    endif
    return cmd
endfunction

function CheckLastCommandData takes boolean pop returns integer
    local integer data = GetLastData()
    if (pop) then
        call PopLastCommand()
    endif
    return data
endfunction

function TotalFoodProduced takes nothing returns integer
    return GetPlayerState(ai_player,PLAYER_STATE_RESOURCE_FOOD_CAP)
endfunction

function ExpansionNeeded takes nothing returns boolean
    return take_exp
endfunction

function BuildExpansion takes integer hallID, integer mineID returns nothing
    if (HallsCompleted(hallID)) then
        call SetBuildExpa(TownCount(hallID) + 1, mineID)
    endif
endfunction

function CurrentAttackWave takes nothing returns integer
    return attackWave
endfunction

function ResetAttackUnits takes nothing returns nothing
    set awGold = 0
    set awWood = 0
    call InitAssaultGroup()
endfunction

function AddAttackUnit takes integer minQty, integer maxQty, integer unitID returns nothing
    // Track attacking gold workers
    if (unitID == 'opeo') then
        set awGold = awGold + minQty
    endif

    // Track attacking wood workers
    if (unitID == 'opeo') then
        set awWood = awWood + minQty
    endif

    call SetAssaultGroup(minQty, maxQty, unitID)
endfunction

//***************************************************************************
//*
//*  Basic Options
//*
//***************************************************************************


function InitOptions takes nothing returns nothing
    call SetMeleeAI()
    call SetDefendPlayer(false)
    call SetRandomPaths(false)
    call SetTargetHeroes(true)
    call SetPeonsRepair(true)
    call SetHeroesFlee(true)
    call SetHeroesBuyItems(false)
    call SetUnitsFlee(true)
    call SetGroupsFlee(true)
    call SetWatchMegaTargets(true)
    call SetIgnoreInjured(true)
    call SetHeroesTakeItems(true)
    call SetSlowChopping(false)
    call SetCaptainChanges(false)
    call SetSmartArtillery(true)
endfunction

//***************************************************************************
//*
//*  Conditions
//*
//***************************************************************************


// Updates the values of all preset conditions

function UpdateConditions takes nothing returns nothing
endfunction

//***************************************************************************
//*
//*  Heroes
//*
//***************************************************************************

// Stores hero ID and skills
function SetHero takes integer order, integer heroid returns nothing
    if (order == 1) then
        set hero_id = heroid
        if (heroid == 'Ofar') then
            set skills1[ 1] = 'AOfs'
            set skills1[ 2] = 'AOsf'
            set skills1[ 3] = 'AOcl'
            set skills1[ 4] = 'AOfs'
            set skills1[ 5] = 'AOsf'
            set skills1[ 6] = 'AOeq'
            set skills1[ 7] = 'AOcl'
            set skills1[ 8] = 'AOfs'
            set skills1[ 9] = 'AOsf'
            set skills1[10] = 'AOcl'
        endif
    endif
endfunction

// Selects hero IDs for three possible heroes
function SelectHeroes takes nothing returns nothing
    call SetHero(1, 'Othr')
    call SetHero(1, 'Orex')
    call SetHero(1, 'Ocbh')
    call SetHero(1, 'Orkn')
endfunction


// Returns the hero skill for the given hero and level
function ChooseHeroSkill takes nothing returns integer
    local integer curHero = GetHeroId()
    local integer level = GetHeroLevelAI()

    if (level > max_hero_level) then
        set max_hero_level = level
    endif

    if (curHero == hero_id) then
        return skills1[level]
    elseif (curHero == hero_id2) then
        return skills2[level]
    elseif (curHero == hero_id3) then
        return skills3[level]
    endif
    return 0
endfunction

//***************************************************************************
//*
//*  Building and Harvesting
//*
//***************************************************************************


// Specifies building priorities for workers
function BuildPriorities takes nothing returns nothing
    local integer mine = TownWithMine()
    call SetBuildAll(BUILD_UNIT, 1, 'ogre', -1)
    call SetBuildAll(BUILD_UNIT, 1, 'opeo', -1)
    call SetBuildAll(BUILD_UNIT, 2, 'opeo', -1)
    call SetBuildAll(BUILD_UNIT, 3, 'opeo', -1)
    call SetBuildAll(BUILD_UNIT, 4, 'opeo', -1)
    call SetBuildAll(BUILD_UNIT, 5, 'opeo', -1)
    call SetBuildAll(BUILD_UNIT, 1, 'ogru', -1)
endfunction


// Specifies harvesting priorities for workers
function HarvestPriorities takes nothing returns nothing
    local integer mine = TownWithMine()
    local integer allGold = GetUnitCountDone('opeo')
    local integer allWood = GetUnitCountDone('opeo')
    local integer numWorkers
    set numWorkers = 5
    call HarvestGold(0, numWorkers)
    set numWorkers = 5
    call HarvestWood(0, numWorkers)
    set numWorkers = 5
    call HarvestGold(1, numWorkers)
    set numWorkers = 4
    call HarvestWood(0, numWorkers)
endfunction


// Determines all building and harvesting assignments for workers
function WorkerAssignment takes nothing returns nothing
    loop
        call UpdateConditions()

        // Harvesting
        call ClearHarvestAI()
        call HarvestPriorities()

        // Building
        call InitBuildArray()
        call BuildPriorities()

        call Sleep(2)
    endloop
endfunction

//***************************************************************************
//*
//*  Attacking
//*
//***************************************************************************


// Returns true if the minimum forces for an attack exist
function HaveMinimumAttackers takes nothing returns boolean
    local integer count

    // Check for attack wave limit
    if (attackWave > 1) then
        return false
    endif

    // First Hero Only
    if (GetUnitCountDone(hero_id) < 1) then
        return false
    endif

    return true
endfunction


// Assigns units to attack based on the given attack group
function PrepareAttackGroup takes integer groupID returns nothing
    local integer all

    // Attack Group #1: All Units
    if (groupID == 1) then
        set all = GetUnitCountDone(hero_id)
        call AddAttackUnit(all, all, hero_id)
        set all = GetUnitCountDone(hero_id2)
        call AddAttackUnit(all, all, hero_id2)
        set all = GetUnitCountDone(hero_id3)
        call AddAttackUnit(all, all, hero_id3)
        set all = GetUnitCountDone('obot')
        call AddAttackUnit(all, all, 'obot')
        set all = GetUnitCountDone('ocat')
        call AddAttackUnit(all, all, 'ocat')
        set all = GetUnitCountDone('odes')
        call AddAttackUnit(all, all, 'odes')
        set all = GetUnitCountDone('odoc')
        call AddAttackUnit(all, all, 'odoc')
        set all = GetUnitCountDone('ogru')
        call AddAttackUnit(all, all, 'ogru')
        set all = GetUnitCountDone('ohun')
        call AddAttackUnit(all, all, 'ohun')
        set all = GetUnitCountDone('okod')
        call AddAttackUnit(all, all, 'okod')
        set all = GetUnitCountDone('oshm')
        call AddAttackUnit(all, all, 'oshm')
        set all = GetUnitCountDone('ospm')
        call AddAttackUnit(all, all, 'ospm')
        set all = GetUnitCountDone('ospw')
        call AddAttackUnit(all, all, 'ospw')
        set all = GetUnitCountDone('osw2')
        call AddAttackUnit(all, all, 'osw2')
        set all = GetUnitCountDone('osw3')
        call AddAttackUnit(all, all, 'osw3')
        set all = GetUnitCountDone('otau')
        call AddAttackUnit(all, all, 'otau')
        set all = GetUnitCountDone('otbr')
        call AddAttackUnit(all, all, 'otbr')
        set all = GetUnitCountDone('owyv')
        call AddAttackUnit(all, all, 'owyv')
        set all = GetUnitCountDone('nqb1')
        call AddAttackUnit(all, all, 'nqb1')
        set all = GetUnitCountDone('ojgn')
        call AddAttackUnit(all, all, 'ojgn')
        set all = GetUnitCountDone('oosc')
        call AddAttackUnit(all, all, 'oosc')

    endif
endfunction


// Prepares an attack group based on the current attack wave
function PrepareForces takes nothing returns nothing
    if (attackWave == 1) then
        call PrepareAttackGroup(1)
    endif
endfunction


// Sleep delays for each attack wave
function AttackWaveDelay takes integer inWave returns nothing
    if (inWave < nextDelay) then
        return
    endif

    set nextDelay = inWave + 1
endfunction


// Advances attack wave counter
function AttackWaveUpdate takes nothing returns nothing
    call AttackWaveDelay(attackWave)
    set attackWave = attackWave + 1
    if (attackWave > 1) then
        set attackWave = 1
        set nextDelay = attackWave + 1
    endif
endfunction


// Basic attack functionality
function AttackTarget takes unit target, boolean addAlliance returns nothing
    if (target == null) then
        return
    endif
    if (addAlliance) then
        call SetAllianceTarget(target)
    endif
    call FormGroup(3, true)
    call AttackMoveKillA(target)
    if (not addAlliance) then
        call SetAllianceTarget(null)
    endif
endfunction


// Initiates an attack based on target priorities
function LaunchAttack takes nothing returns nothing
    local unit target = null
    local boolean setAlly = true

    // Don't launch any attack while town is threatened
    if (TownThreatened()) then
        call Sleep(2)
        return
    endif

    // Target Priority #1
    if (target == null) then
        set target = GetAllianceTarget()
        if (target != null) then
            set setAlly = false
        endif
    endif

    // Target Priority #2
    if (target == null) then
        set target = GetExpansionFoe()
        if (target != null) then
            set take_exp = false
        endif
    endif

    // Target Priority #3
    if (target == null) then
        set target = GetMegaTarget()
    endif

    // Target Priority #4
    if (target == null) then
        set target = GetEnemyExpansion()
    endif

    // Target Priority #5
    if (target == null) then
        set target = GetEnemyExpansion()
        if (target == null) then
            call StartGetEnemyBase()
            loop
                exitwhen (not WaitGetEnemyBase())
                call SuicideSleep(1)
            endloop
            set target = GetEnemyBase()
        endif
    endif

    // Target Priority #6
    if (target == null) then
        set target = GetCreepCamp(0, 9, false)
    endif

    // Target Priority #7
    if (target == null) then
        set target = GetCreepCamp(10, 100, true)
    endif

    // Attack the target and increment attack wave
    if (target != null) then
        call AttackTarget(target, setAlly)
        call AttackWaveUpdate()
    else
        // If no target was found, sleep a bit before trying again
        call Sleep(20)
    endif
endfunction


// Determines all attacking assignments
function AttackAssignment takes nothing returns nothing
    call StaggerSleep(0, 2)
    if (attackWave == 1) then
        call AttackWaveDelay(0)
    endif
    loop
        loop
            call UpdateConditions()
            exitwhen (HaveMinimumAttackers() and not CaptainRetreating())
            call Sleep(2)
        endloop
        call RemoveInjuries()
        call ResetAttackUnits()
        call PrepareForces()
        call LaunchAttack()
    endloop
endfunction

//***************************************************************************
//*
//*  Main Entry Point
//*
//***************************************************************************

function main takes nothing returns nothing
    call InitAI()
    call SetPlayerName(ai_player, "Frostwolf (AI)")
    call InitOptions()
    call SelectHeroes()
    call CreateCaptains()
    call SetHeroLevels(function ChooseHeroSkill)

    call Sleep(0.1)
    call StartThread(function WorkerAssignment)
    call StartThread(function AttackAssignment)
    call PlayGame()
endfunction